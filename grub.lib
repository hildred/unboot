function start_ser {
	if ! insmod serial; then
		echo serial load failed
		set serr=4
	elif ! serial --unit=0 --speed=115200;then
		echo serial conf err
		set serr=3
	elif ! terminal_output --append serial; then
		echo output error
		set serr=2
	elif ! terminal_input --append serial; then
		echo input set err
		set serr=1
	else
		echo mark 1
		set serr=0
	fi
}

function savedefault {
	if [ -z "${boot_once}" ]; then
		saved_entry="${chosen}"
		save_env saved_entry
	fi
}

function load_video {
	if loadfont $prefix/unicode.pf2 ; then
		#set gfxmode=640x480
		set gfxmode=auto
		insmod vbe
		insmod vga
		insmod video_bochs
		insmod video_cirrus
		if insmod gfxterm; then
			terminal_output --append gfxterm
		fi
		set locale_dir=$prefix/locale
		set lang=en_US
		insmod gettext
	fi

	insmod png
	if background_image $prefix/joy-grub.png; then
		set color_normal=white/black
		set color_highlight=black/white
	else
		set menu_color_normal=cyan/blue
		set menu_color_highlight=white/blue
	fi
}

if cpuid -l ; then
	set arch=amd64
else
	set arch=i386
fi

if [ -s $prefix/grubenv ]; then
	load_env
fi

if [ "${prev_saved_entry}" ]; then
	set saved_entry="${prev_saved_entry}"
	save_env saved_entry
	set prev_saved_entry=
	save_env prev_saved_entry
	set boot_once=true
fi

set default="0"

load_video
start_ser

